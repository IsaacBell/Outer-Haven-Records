!function(t){"use strict";function e(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}function i(t){var e=0;for(var i in t)t.hasOwnProperty(i)&&e++;return e}function s(t,e,i){var s;return function(){var n=this,r=arguments,a=function(){s=null,i||t.apply(n,r)},o=i&&!s;clearTimeout(s),s=setTimeout(a,e),o&&t.apply(n,r)}}function n(t,e,i,s,n,r){var a,o,c,l,h,u,p,d,f;if(o=s-t,c=n-e,l=Math.sqrt(c*c+o*o),l>i+r)return!1;if(l<Math.abs(i-r))return!1;a=(i*i-r*r+l*l)/(2*l),d=t+o*a/l,f=e+c*a/l,h=Math.sqrt(i*i-a*a),u=-c*(h/l),p=o*(h/l);var y=d+u,m=f+p;return{x:y,y:m}}function r(t,i){this.el=t,this.audioCtx=new AudioContext,this.options=e({},this.options),e(this.options,i),this.noiseVal=this.options.noiseGain,this.bufferDelay=2,this.armRotation=0,this.speakers=this.audioCtx.destination,this.effect=-1,this.convolver=this.audioCtx.createConvolver(),this.ui={player:this.el.querySelector(".player__element--lp"),recordCover:this.el.querySelector(".player__svg-lp > path#cover"),arm:this.el.querySelector(".player__element--tonearm > svg"),visualizer:this.el.querySelector(".player-stand > .visualizer")},this.ctrls={back:this.el.querySelector(".control-button--back"),play:this.el.querySelector(".player__controls > button.player-button--playstop"),playStatus:this.el.querySelector(".player__controls > button.player-button--playstop .icon--play"),stopStatus:this.el.querySelector(".player__controls > button.player-button--playstop .icon--stop"),rotate:this.el.querySelector(".player__controls > button.player-button--rotate"),vinylFx:this.el.querySelector(".effects > button.effects__button--vinyleffect"),roomFx:[].slice.call(this.el.querySelectorAll(".effects > .effects__irs > .effects__button"))},this.infoElems={artist:this.el.querySelector(".player-info > .artist--player"),title:this.el.querySelector(".player-info > .title--player"),year:this.el.querySelector(".player-info > .year--player"),song:this.el.querySelector(".player-stand > .song")};var s=this.ui.arm.getBoundingClientRect();this.armCenterPoint={x:s.left+s.width/2,y:s.top+s.height/2},this.cartridgeMargin=8,this.angleInterval={min:this._getAngle(this.ui.player),max:this._getAngle(this.ui.recordCover)},this._createAnalyser(),this._initEvents()}function a(t){this.wrapper=t,this.cover=this.wrapper.querySelector(".img-wrap--single"),this.position=this.wrapper.querySelector(".number"),this.artist=this.wrapper.querySelector(".artist"),this.title=this.wrapper.querySelector(".title"),this.year=this.wrapper.querySelector(".year"),this.info={coverImg:this.cover.querySelector("img").src,artist:this.artist.innerHTML,title:this.title.innerHTML,year:this.year.innerHTML,sides:{side1:this.wrapper.getAttribute("data-side1")?this.wrapper.getAttribute("data-side1").split(","):[],side2:this.wrapper.getAttribute("data-side2")?this.wrapper.getAttribute("data-side2").split(","):[]}}}function o(t,i){this.el=t,this.options=e({},this.options),e(this.options,i),this.records=[];var s=this;[].slice.call(this.el.querySelectorAll(".single")).forEach(function(t){var e=new a(t);s.records.push(e)}),this.recordsTotal=this.records.length,this.current=0,this.ctrls={next:this.el.querySelector(".controls__navigate > button.control-button--next"),prev:this.el.querySelector(".controls__navigate > button.control-button--prev"),play:this.el.querySelector("button.control-button--play"),back:this.el.querySelector("button.control-button--back")},this.lpPlayCtrlPath=this.ctrls.play.querySelector("svg.icon--progress > path"),this.lpPlayCtrlPathLen=this.lpPlayCtrlPath.getTotalLength(),dynamics.css(this.lpPlayCtrlPath,{strokeDasharray:this.lpPlayCtrlPathLen,strokeDashoffset:this.lpPlayCtrlPathLen}),this._initEvents()}function c(){var t=function(){classie.add(S,"grid--loaded"),f(),g=new o(document.querySelector(".view--single"),{onStop:function(){d("single","grid"),m()},onLoadRecord:function(t,e,i){_.loadRecord(t.info,function(){_.setRecordInfo(t.info),setTimeout(function(){g._showRecord()},50)},function(t){g.isLoading&&dynamics.animate(e,{strokeDashoffset:i*(1-t/100)},{duration:100,type:dynamics.linear})})},onShowRecord:function(t){dynamics.css(x,{opacity:1}),x.querySelector("image").setAttribute("xlink:href",t.info.coverImg),d("single","player"),setTimeout(function(){_.start()},600)}})};l(t)}function l(t){var e=0,i=function(){++e,2===e&&"function"==typeof t&&t()};h(i),u(function(t){p(t),i()})}function h(t){imagesLoaded(b.grid,function(){new Masonry(".grid",{itemSelector:".grid__item"}),"function"==typeof t&&t()})}function u(t){new AbbeyLoad([{room1:"mp3/room1.mp3",room2:"mp3/room2.mp3",room3:"mp3/room3.mp3",noise:"mp3/noise1.mp3"}],function(e){"function"==typeof t&&t(e)})}function p(t){_=new r(b.player,{noiseBuffer:t.noise,effectBuffers:[t.room1,t.room2,t.room3],onGoBack:function(){d("player","single"),g.restart(function(){dynamics.css(x,{opacity:0})})}})}function d(t,e){classie.remove(b[t],"view--current"),classie.add(b[e],"view--current")}function f(){w.forEach(function(t,e){t.addEventListener("click",function(t){t.preventDefault(),y({x:t.pageX,y:t.pageY},function(){d("grid","single")}),setTimeout(function(){g.start(e)},80)})});var e=s(function(e){v={width:t.innerWidth,height:t.innerHeight}},10);t.addEventListener("resize",e)}function y(t,e){dynamics.css(C,{opacity:1,left:t.x,top:t.y,backgroundColor:"#45918e",scale:0}),dynamics.animate(C,{scale:1.5,backgroundColor:"#45cb96"},{duration:500,type:dynamics.easeOut,complete:function(){"function"==typeof e&&e()}})}function m(){dynamics.css(C,{left:t.innerWidth/2,top:t.innerHeight/2}),dynamics.animate(C,{opacity:0},{duration:500,type:dynamics.easeOut})}var v={width:t.innerWidth,height:t.innerHeight};r.prototype.options={noiseBuffer:"",noiseGain:.5,effectBuffers:[],onGoBack:function(){return!1}},r.prototype._loadAssets=function(t,e,i){new AbbeyLoad(t,function(t){e(t)},i)},r.prototype.loadRecord=function(t,e,s){var n=this;this.recordData={artist:t.artist,title:t.title,side1:{totalDuration:0,totalBuffers:0,bufferList:[],bufferNames:[]},side2:{totalDuration:0,totalBuffers:0,bufferList:[],bufferNames:[]}};var r=0,a=function(t,a,o){n._loadAssets(a,function(s){var a=n.recordData[t];a.bufferList=s,a.totalBuffers=i(a.bufferList);for(var c=0;c<a.totalBuffers;++c)a.totalDuration+=a.bufferList["buffer"+(c+1)].duration;++r,2===r?(n.currentBuffer=1,n.currentSide=1,n.isReady=!0,e()):o()},function(t){var e=0;e=1>r?50*t/100:(t+100)/2,s(e)})},o=function(e){for(var i=[],s={},r=0,a=t.sides[e].length;a>r;++r)s["buffer"+(r+1)]=t.sides[e][r];return i.push(s),n.recordData[e].bufferNames=i,i};a("side1",o("side1"),function(){a("side2",o("side2"))})},r.prototype.start=function(){this.isReady&&(this._play(),this._operate(),this._ctrlPlay("play"))},r.prototype._getCurrentSide=function(){return this.recordData["side"+this.currentSide]},r.prototype._play=function(t){this.source=this.audioCtx.createBufferSource(),this.source.buffer=this._getCurrentSide().bufferList["buffer"+this.currentBuffer],this.infoElems.song.innerHTML=this._getSongName(this._getCurrentSide().bufferNames[0]["buffer"+this.currentBuffer]),this.setEffect(),this.source.start(t&&t>0?this.audioCtx.currentTime:this.audioCtx.currentTime+this.bufferDelay,t?t:0);var e=this;this.analyserTimeout&&clearTimeout(this.analyserTimeout),this.analyserTimeout=setTimeout(function(){e._analyse()},t&&t>0?0:1e3*this.bufferDelay);var e=this;this.sourceEnded=function(){e.isDragging||(e.currentBuffer<e._getCurrentSide().totalBuffers&&e.isPlatterRotating?(e.source.stop(0),e.currentBuffer++,e._play()):e.stop())},this.source.onended=this.sourceEnded},r.prototype._getSongName=function(t){return t.substring(4,t.indexOf(".mp3"))},r.prototype._createAnalyser=function(){this.analyser=this.audioCtx.createAnalyser(),this.canvas=document.createElement("canvas"),this.ui.visualizer.appendChild(this.canvas),this.canvasCtx=this.canvas.getContext("2d"),this.canvasSize={width:this.ui.visualizer.clientWidth,height:this.ui.visualizer.clientHeight},this.canvas.setAttribute("width",this.canvasSize.width),this.canvas.setAttribute("height",this.canvasSize.height)},r.prototype._analyse=function(){t.cancelAnimationFrame(this.drawVisual),this.analyser.fftSize=2048;var e=this.analyser.frequencyBinCount,i=new Uint8Array(e),s=this.canvasSize.width,n=this.canvasSize.height,r=this;this.canvasCtx.clearRect(0,0,s,n);var a=function(){r.drawVisual=requestAnimationFrame(a),r.analyser.getByteTimeDomainData(i),r.canvasCtx.fillStyle="#45bd94",r.canvasCtx.fillRect(0,0,s,n),r.canvasCtx.lineWidth=1,r.canvasCtx.strokeStyle="#474283",r.canvasCtx.beginPath();for(var t=1*s/e,o=0,c=0;e>c;c++){var l=i[c]/128,h=l*n/2;0===c?r.canvasCtx.moveTo(o,h):r.canvasCtx.lineTo(o,h),o+=t}r.canvasCtx.lineTo(s,n/2),r.canvasCtx.stroke()};a()},r.prototype._stopAnalysing=function(){t.cancelAnimationFrame(this.drawVisual),this.canvasCtx.clearRect(0,0,this.canvas.width,this.canvas.height)},r.prototype._operate=function(t,e){var t=t||1;if(this._createNoise(),this._playNoise(),1===t){this._moveArmTo(1);var i=this;this.armtimeout=dynamics.setTimeout(function(){i._animateArm()},1e3*this.bufferDelay),this._startPlatterRotation()}else if(2===t){var i=this;this.armtimeout=dynamics.setTimeout(function(){i._animateArm(e)},e===this.totalDuration?1e3*this.bufferDelay:0)}},r.prototype.stop=function(){this.armtimeout&&dynamics.clearTimeout(this.armtimeout),this.source.removeEventListener("ended",this.sourceEnded),this.source.stop(0),this.currentBuffer=1,this._stopNoise(),this._stopAnalysing(),dynamics.stop(this.ui.arm),this.isDragging||(this._moveArmTo(0),this._stopPlatterRotation(),this._ctrlPlay("stop")),this.analyserTimeout&&clearTimeout(this.analyserTimeout)},r.prototype._resume=function(){if(this.armRotation<this.angleInterval.min||this.armRotation>=this.angleInterval.max)this._moveArmTo(0),this._stopPlatterRotation(),this._ctrlPlay("stop");else{var t=this._getCurrentInfoFromAngle();this.currentBuffer=t.bufferIdx,this._play(t.bufferOffset),this._operate(2,t.remainingTime)}},r.prototype._getCurrentInfoFromAngle=function(){for(var t=-1,e=0,i=0,s=-1,n=this.armRotation*this._getCurrentSide().totalDuration/(this.angleInterval.max-this.angleInterval.min)-this.angleInterval.min*this._getCurrentSide().totalDuration/(this.angleInterval.max-this.angleInterval.min),r=0;r<this._getCurrentSide().totalBuffers;++r){if(e+=this._getCurrentSide().bufferList["buffer"+(r+1)].duration,e>n){t=r+1,s=n-i;break}i=e}return{remainingTime:this._getCurrentSide().totalDuration-n,bufferIdx:t,bufferOffset:s}},r.prototype._createNoise=function(){this.noise=this.audioCtx.createBufferSource(),this.noise.buffer=this.options.noiseBuffer,this.noiseGain=this.audioCtx.createGain(),this.noiseGain.gain.value=this.noiseVal,this.noise.connect(this.noiseGain),this.noiseGain.connect(this.audioCtx.destination),this.noise.loop=!0},r.prototype._playNoise=function(){this.noise.start(0)},r.prototype._stopNoise=function(t){this.noise.stop(0)},r.prototype._adjustNoiseGain=function(t){this.noiseGain&&(this.noiseGain.gain.value=t)},r.prototype.setNoise=function(t){this.noiseVal=t?this.options.noiseGain:0,this._adjustNoiseGain(this.noiseVal)},r.prototype.setEffect=function(t){this.effect=void 0!=t?t:this.effect,this.source&&(-1===this.effect?(this.source.disconnect(),this.convolver.disconnect(),this.source.connect(this.analyser),this.analyser.connect(this.speakers)):(this.convolver.buffer=this.options.effectBuffers[this.effect],this.source.connect(this.analyser),this.analyser.connect(this.convolver),this.convolver.connect(this.speakers)))},r.prototype._getAngle=function(t){var e=t.getBoundingClientRect(),i=this.ui.arm.getBoundingClientRect(),s=e.width/2,r=e.left+e.width/2,a=e.top+e.height/2,o=i.width/2,c=i.left+i.width/2,l=i.top+i.height/2,h=n(r,a,s,c,l,o),u=180*Math.atan2(this.armCenterPoint.y-h.y,this.armCenterPoint.x-h.x)/Math.PI;return u+90-this.cartridgeMargin},r.prototype._moveArmTo=function(t,e){dynamics.stop(this.ui.arm),dynamics.animate(this.ui.arm,{rotateZ:t?this.angleInterval.min:0},{duration:e||1e3,type:dynamics.spring,frequency:200,friction:400}),this.armRotation=t?this.angleInterval.min:0},r.prototype._animateArm=function(t){var e=this,i=this.angleInterval.max,s=this.armRotation>0?this.armRotation:this.angleInterval.min;dynamics.stop(this.ui.arm),dynamics.animate(this.ui.arm,{rotateZ:this.angleInterval.max},{duration:void 0!=t&&t!==this._getCurrentSide().totalDuration?1e3*t:1e3*(this._getCurrentSide().totalDuration+this.bufferDelay),type:dynamics.linear,change:function(t,n){e.armRotation=(i-s)*n+s}})},r.prototype._startPlatterRotation=function(){this.isPlatterRotating=!0,classie.add(this.ui.player,"player__element--lp-spin")},r.prototype._stopPlatterRotation=function(){this.isPlatterRotating=!1,classie.remove(this.ui.player,"player__element--lp-spin")},r.prototype.setRecordInfo=function(t){this.infoElems.artist.innerHTML=t.artist,this.infoElems.title.innerHTML=t.title,this.infoElems.year.innerHTML=t.year},r.prototype._initEvents=function(){var e=this,i=-1,n=0,r=180/Math.PI;this.startDragging=function(){e.isDragging=!0,n=e.armRotation?e.armRotation:n,e.source&&e.stop(),document.addEventListener("mousemove",e.dragging),document.addEventListener("mouseup",e.stopDragging)},this.dragging=function(t){var s=Math.atan2(e.armCenterPoint.y-t.pageY,e.armCenterPoint.x-t.pageX)*r;i&&-1!=i||(i=s);var a=s-i+e.armRotation;0>a?a=0:a>e.angleInterval.max&&(a=e.angleInterval.max),n=a,dynamics.css(e.ui.arm,{rotateZ:n})},this.stopDragging=function(){e.isDragging=!1,document.removeEventListener("mousemove",e.dragging),document.removeEventListener("mouseup",e.stopDragging),e.armRotation=n,i=-1,e.isPlatterRotating&&e._resume()},this.ui.arm.addEventListener("mousedown",this.startDragging),this.debounceResize=s(function(t){var i=e.ui.arm.getBoundingClientRect();e.armCenterPoint={x:i.left+i.width/2,y:i.top+i.height/2},e.angleInterval={min:e._getAngle(e.ui.player),max:e._getAngle(e.ui.recordCover)},e.drawVisual&&(e.canvasSize={width:e.ui.visualizer.clientWidth,height:e.ui.visualizer.clientHeight},e.canvas.setAttribute("width",e.canvasSize.width),e.canvas.setAttribute("height",e.canvasSize.height),e._analyse())},10),t.addEventListener("resize",this.debounceResize),this.ctrls.back.addEventListener("click",function(){e._ctrlBack()}),this.ctrls.play.addEventListener("click",function(){classie.has(e.ctrls.playStatus,"icon--hidden")?(e._ctrlPlay("stop"),e.stop()):(e._ctrlPlay("play"),e.start())}),this.ctrls.vinylFx.addEventListener("click",function(){e._ctrlVinylFx()}),this.ctrls.roomFx.forEach(function(t,i){t.addEventListener("click",function(){e._ctrlRoomFx(t,i)})}),this.ctrls.rotate.addEventListener("click",function(){e._ctrlRotate()}),this.touchStartFix=function(){var i=e.audioCtx.createBuffer(1,1,22050),s=e.audioCtx.createBufferSource();s.buffer=i,s.connect(e.audioCtx.destination),s.start(0),t.removeEventListener("touchstart",e.touchStartFix)},t.addEventListener("touchstart",this.touchStartFix)},r.prototype._ctrlBack=function(){this.stop(),this.options.onGoBack(),classie.has(this.ui.player,"player__element--lp-flip")&&classie.remove(this.ui.player,"player__element--lp-flip")},r.prototype._ctrlPlay=function(t){classie.remove("stop"===t?this.ctrls.playStatus:this.ctrls.stopStatus,"icon--hidden"),classie.add("stop"===t?this.ctrls.stopStatus:this.ctrls.playStatus,"icon--hidden")},r.prototype._ctrlVinylFx=function(){var t=classie.has(this.ctrls.vinylFx,"effects__button--active");this.setNoise(!t),t?classie.remove(this.ctrls.vinylFx,"effects__button--active"):classie.add(this.ctrls.vinylFx,"effects__button--active")},r.prototype._ctrlRoomFx=function(t,e){this.ctrls.roomFx.forEach(function(e){classie.has(e,"effects__button--active")&&e!=t&&classie.remove(e,"effects__button--active")});var i=classie.has(t,"effects__button--active");i?(classie.remove(t,"effects__button--active"),this.setEffect(-1)):(classie.add(t,"effects__button--active"),this.setEffect(e))},r.prototype._ctrlRotate=function(t,e){this.isPlatterRotating&&this.stop(),this.currentSide=1===this.currentSide?2:1,classie.has(this.ui.player,"player__element--lp-flip")?classie.remove(this.ui.player,"player__element--lp-flip"):classie.add(this.ui.player,"player__element--lp-flip")},a.prototype.layout=function(t){switch(t){case"down":dynamics.css(this.cover,{opacity:1,translateY:v.height}),dynamics.css(this.position,{opacity:1,translateY:v.height-200}),dynamics.css(this.artist,{opacity:1,translateY:v.height-200}),dynamics.css(this.title,{opacity:1,translateY:v.height-180}),dynamics.css(this.year,{opacity:1,translateY:v.height-250});break;case"right":dynamics.css(this.cover,{opacity:1,translateX:v.width+600}),dynamics.css(this.position,{opacity:1,translateX:v.width+150}),dynamics.css(this.artist,{opacity:1,translateX:v.width}),dynamics.css(this.title,{opacity:1,translateX:v.width+150}),dynamics.css(this.year,{opacity:1,translateX:v.width+50});break;case"left":dynamics.css(this.cover,{opacity:1,translateX:-v.width-600}),dynamics.css(this.position,{opacity:1,translateX:-v.width-150}),dynamics.css(this.artist,{opacity:1,translateX:-v.width}),dynamics.css(this.title,{opacity:1,translateX:-v.width-150}),dynamics.css(this.year,{opacity:1,translateX:-v.width-50});break;case"hidden":dynamics.css(this.cover,{opacity:0}),dynamics.css(this.position,{opacity:0}),dynamics.css(this.artist,{opacity:0}),dynamics.css(this.title,{opacity:0}),dynamics.css(this.year,{opacity:0})}},a.prototype.animate=function(t,e){var i=600,s=dynamics.bezier,n=[{x:0,y:0,cp:[{x:.2,y:1}]},{x:1,y:1,cp:[{x:.3,y:1}]}],r={left:{translateX:-v.width,translateY:0,opacity:1},right:{translateX:v.width,translateY:0,opacity:1},center:{translateX:0,translateY:0,opacity:1}};dynamics.animate(this.cover,r[t],{duration:i,type:s,points:n,complete:function(){"function"==typeof e&&e()}}),dynamics.animate(this.position,r[t],{duration:i,type:s,points:n}),dynamics.animate(this.artist,r[t],{duration:i,type:s,points:n}),dynamics.animate(this.title,r[t],{duration:i,type:s,points:n}),dynamics.animate(this.year,r[t],{duration:i,type:s,points:n})},o.prototype.options={onStop:function(){return!1},onLoadRecord:function(){return!1},onShowRecord:function(){return!1}},o.prototype.start=function(t){this.current=t;var e=this.records[this.current];classie.add(e.wrapper,"single--current"),e.layout("down"),e.animate("center"),this._showPlayCtrl()},o.prototype.restart=function(t){var e=this.records[this.current];classie.add(e.wrapper,"single--current"),e.layout("left"),e.animate("center",t),this._showPlayCtrl()},o.prototype._initEvents=function(){var t=this;this.ctrls.next.addEventListener("click",function(){t._navigate("right")}),this.ctrls.prev.addEventListener("click",function(){t._navigate("left")}),this.ctrls.back.addEventListener("click",function(){t._stop()}),this.ctrls.play.addEventListener("click",function(){t._loadRecord()})},o.prototype._navigate=function(t){var e=this;this.isLoading&&this._cancelRecordLoading(),this._hidePlayCtrl();var i=this.records[this.current];"right"===t?this.current=this.current<this.recordsTotal-1?this.current+1:0:this.current=this.current>0?this.current-1:this.recordsTotal-1;var s=this.records[this.current];classie.add(s.wrapper,"single--current"),i.animate("right"===t?"left":"right",function(){classie.remove(i.wrapper,"single--current")}),s.layout(t),s.animate("center",function(){e._showPlayCtrl()})},o.prototype._loadRecord=function(){return this.isLoading?!1:(classie.add(this.ctrls.play,"control-button--active"),this.isLoading=!0,void this.options.onLoadRecord(this.records[this.current],this.lpPlayCtrlPath,this.lpPlayCtrlPathLen))},o.prototype._showRecord=function(){if(!this.isLoading)return!1;var t=this.records[this.current];t.animate("left",function(){t.layout("hidden"),classie.remove(t.wrapper,"single--current")}),this._hidePlayCtrl(),this.options.onShowRecord(t),this._cancelRecordLoading()},o.prototype._stop=function(){this.isLoading&&this._cancelRecordLoading();var t=this.records[this.current];t.layout("hidden"),classie.remove(t.wrapper,"single--current"),this._hidePlayCtrl(),this.options.onStop()},o.prototype._cancelRecordLoading=function(){this.isLoading=!1,classie.remove(this.ctrls.play,"control-button--active"),dynamics.stop(this.lpPlayCtrlPath),dynamics.css(this.lpPlayCtrlPath,{strokeDasharray:this.lpPlayCtrlPathLen,strokeDashoffset:this.lpPlayCtrlPathLen})},o.prototype._showPlayCtrl=function(){dynamics.animate(this.ctrls.play,{opacity:1},{duration:200,type:dynamics.easeOut})},o.prototype._hidePlayCtrl=function(){dynamics.css(this.ctrls.play,{opacity:0})};var g,_,b={grid:document.querySelector(".view--grid"),single:document.querySelector(".view--single"),player:document.querySelector(".view--player")},S=b.grid.querySelector("ul.grid"),w=[].slice.call(S.querySelectorAll("li.grid__item")),C=document.querySelector(".deco-expander"),x=b.player.querySelector(".player__element--lp");c(),t.AudioContext=t.AudioContext||t.webkitAudioContext}(window);